\ProvidesPackage{dissertation}

\DeclareOption{ibs}{\gdef\includeibslogo{}}
\ProcessOptions\relax

% =================================================================
% =================================================================
% =================================================================
% =================================================================
% =================================================================
%
% Hey! Don't mess with this file unless you know what you're doing!
%
% =================================================================
% =================================================================
% =================================================================
% =================================================================
% =================================================================

\RequirePackage{eurosym}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsfonts}
\RequirePackage[onehalfspacing]{setspace}
\RequirePackage{chngcntr}
\RequirePackage{graphicx}
\RequirePackage[a4paper, margin=2.5cm]{geometry}
\RequirePackage[english]{babel}
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage{enumitem}
\RequirePackage{etoolbox}
\RequirePackage[printonlyused]{acronym}

\RequirePackage[
    backend=biber,
    style=ieee,
    mincitenames=1,
    maxcitenames=3, 
    minbibnames=3,
    maxbibnames=99,
    uniquename=false,
    uniquelist=false
]{biblatex}

\RequirePackage{caption}
\RequirePackage{subcaption}
\RequirePackage{listings}
\RequirePackage{booktabs}
\RequirePackage{microtype} 
\RequirePackage{xcolor}
\RequirePackage{url}
\RequirePackage{tipa}
\RequirePackage{bigfoot}
\RequirePackage{minted}
\RequirePackage{algorithm}
\RequirePackage{algorithmicx}
\RequirePackage{algpseudocode}
\RequirePackage{csquotes}
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{environ}
\RequirePackage{xstring}
\RequirePackage[useregional]{datetime2}
%
% you may need to uncomment the command below if you use eps format for figures
%\usepackage{epstopdf}
%

\lstdefinestyle{prettycode}{
    backgroundcolor=\color{gray!3!white},
    commentstyle={\color{darkgray!90!white}\ttfamily},
    %commentstyle=\color{codegreen},
    %keywordstyle=\color{magenta},
    %numberstyle=\tiny\color{codegray},
    %stringstyle=\color{codepurple},
    frame=single,
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    %numbers=left,                    
    %numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=prettycode}

\titleformat{\subsubsection}{\normalfont\normalsize\bfseries}{\thesubsubsection}{0.5em}{}
\titlespacing*{\subsubsection}
{0pt}{2.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

%
\makeatletter
    \def\section{\@startsection{section}{1}%
      \z@{.5\linespacing\@plus.7\linespacing}{.25\linespacing}%
      {\normalfont\bfseries\flushleft}}
      
    \def\subsection{\@startsection{subsection}{2}%
      \z@{.5\linespacing\@plus.7\linespacing}{.25\linespacing}%
      {\normalfont\bfseries\flushleft}}

    \def\subsubsection{\@startsection{subsubsection}{3}%
      \z@{.5\linespacing\@plus.7\linespacing}{.1\linespacing}%
      {\normalfont\itshape}}

    \let\@afterindenttrue\@afterindentfalse
\makeatother

\setcounter{MaxMatrixCols}{10}
%
\providecommand{\U}[1]{\protect\rule{.1in}{.1in}}
\theoremstyle{plain}
\newtheorem{acknowledgement}{Acknowledgement}
\newtheorem{axiom}{Axiom}[chapter]
\newtheorem{case}{Case}[chapter]
\newtheorem{claim}{Claim}[chapter]
\newtheorem{conclusion}{Conclusion}[chapter]
\newtheorem{condition}{Condition}[chapter]
\newtheorem{conjecture}{Conjecture}[chapter]
\newtheorem{corollary}{Corollary}[chapter]
\newtheorem{criterion}{Criterion}[chapter]
\newtheorem{definition}{Definition}[chapter]
\newtheorem{example}{Example}[chapter]
\newtheorem{exercise}{Exercise}[chapter]
\newtheorem{lemma}{Lemma}[chapter]
\newtheorem{notation}{Notation}[chapter]
\newtheorem{problem}{Problem}[chapter]
\newtheorem{proposition}{Proposition}[chapter]
\newtheorem{remark}{Remark}[chapter]
\newtheorem{solution}{Solution}[chapter]
\newtheorem{summary}{Summary}[chapter]
\newtheorem{theorem}{Theorem}[chapter]
\numberwithin{equation}{chapter}
%
\makeatletter
\newcommand\frontFont{\@setfontsize\frontFont{14}{14}}
\newcommand\numberprefix{}
\def\numberline#1{\hb@xt@\@tempdima{\numberprefix #1\hfil}}

% ============================================================
\newcommand{\lofskip}[1]{\gdef\listOfFiguresLeftSpacing{#1}}
\newcommand{\lotskip}[1]{\gdef\listOfTablesLeftSpacing{#1}}
% ============================================================

% List of Figures
\def\l@figure#1#2{\@tocline{0}{3pt plus2pt}{0pt}{\ifdef\listOfFiguresLeftSpacing{\listOfFiguresLeftSpacing}{6pc}}{}%
  {\renewcommand\numberprefix{Figure~}#1}{#2}}

% List of Tables
\def\l@table#1#2{\@tocline{0}{3pt plus2pt}{0pt}{\ifdef\listOfTablesLeftSpacing{\listOfTablesLeftSpacing}{6pc}}{}%
  {\renewcommand\numberprefix{Table~}#1}{#2}}
\makeatother

\makeatletter
\def\cleardoublepage{\clearpage\if@twoside%
  \ifodd\c@page\else
  \vspace*{\fill}
  \hfill
  \begin{center}
  {\fontfamily{Montserrat-TOsF}\selectfont\small [ This page is intentionally left blank. ]}
  
  \end{center}
  \vspace{\fill}
  \thispagestyle{empty}
  \newpage
 \if@twocolumn\hbox{}\newpage\fi\fi\fi
}
\makeatother

%
% Please write the references according to your school
%
\newenvironment{dedicationenv}
  {%\clearpage           % we want a new page
   \thispagestyle{empty}% no header and footer
   \vspace*{\stretch{1}}% some space at the top
   %\itshape             % the text is in italics
   \raggedleft          % flush to the right margin
  }
  {\par % end the paragraph
   \vspace{\stretch{3}} % space at bottom is three times that at the top
   %\clearpage           % finish off the page
  }
  \numberwithin{section}{chapter}
\fancyhf{}
\pagestyle{fancy}
\fancyfoot[LE,RO]{\normalsize\thepage}
%
\makeatletter
\def\ps@plain{\ps@empty
 \def\@evenfoot{%
   \normalfont\normalsize
   \rlap{\thepage}\hfil
   }%
 \def\@oddfoot{%
   \normalfont\normalsize\hfil
   \llap{\thepage}
   }%
}
\makeatother
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
%
\usepackage{montserrat}
\usepackage[T1]{fontenc}
\renewcommand*\oldstylenums[1]{{\fontfamily{Montserrat-TOsF}\selectfont #1}}
%
\numberwithin{table}{chapter}
\numberwithin{figure}{chapter}

\setlength{\parindent}{0.7cm}

\addto{\extrasenglish}{%
  \renewcommand{\bibname}{References}
}

\let\olddocument=\document
\let\oldenddocument=\enddocument

\makeatletter
\def\l@subsection{\@tocline{2}{0pt}{2.5pc}{5pc}{}}
\makeatother

% =================================================================
\renewcommand{\title}[1]{\gdef\thetitle{#1}}

\renewcommand{\date}[2]{
    \gdef\thedate{#1, #2}
    \gdef\themonth{#1}
    \gdef\theyear{#2}
}

\newcommand{\dateorinvalid}[3]{ % month, year, error (1 | 0)
    \IfInteger{#2}{
        \DTMsavenow{now}
        \ifnum\number#2<\DTMfetchyear{now}
            \ifnum#3=1\PackageError{Thesis}{Invalid year "#2". You can't publish a thesis in the past! The year must be at least \DTMfetchyear{now}}{}\else\fi
            {\color{red}\textbf{\textsc{Error:} Invalid Date}} 
        \else
            \IfStrEqCase{#1}{
                {January}{#1, #2}
                {February}{#1, #2}
                {March}{#1, #2}
                {April}{#1, #2}
                {May}{#1, #2}
                {June}{#1, #2}
                {July}{#1, #2}
                {August}{#1, #2}
                {September}{#1, #2}
                {October}{#1, #2}
                {November}{#1, #2}
                {December}{#1, #2}}
                [
                    \ifnum#3=1\PackageError{Thesis}{Invalid month "#1". Should be one of: January, February, March, April, May, June, July, August, September, October, November, December (case-sensitive)}{}\else\fi
                    {\color{red}\textbf{\textsc{Error:} Invalid Date}}
                ]
        \fi
    }{
        \ifnum#3=1\PackageError{Thesis}{Year "#2" is not an integer}{}\else\fi
        {\color{red}\textbf{\textsc{Error:} Invalid Date}}
    }
}

\renewcommand{\author}[1]{\gdef\theauthor{#1}}

\newcommand{\department}[1]{\gdef\thedepartment{#1}}

\newcommand{\program}[1]{\gdef\theprogram{#1}}

% SUPERVISORS
% ========================================================
\newcounter{numsupervisors}
\newcommand{\supervisor}[2]{
    \stepcounter{numsupervisors}
    \ifnum\value{numsupervisors}>2
        \PackageError{Dissertation}{You're trying to provide \arabic{numsupervisors} supervisors, which is not allowed. Your dissertation can only have up to two supervisors: two from ISCTE-IUL, or one from ISCTE-IUL and one from another institution}{}
    \else
        \ifdef\thesupervisors{
            \edef\thesupervisors{\thesupervisors{}~\\~\\#1,\\#2}
        }{ % else
            \gdef\thesupervisors{#1,\\#2}
        }
    \fi
}
% ========================================================

\newcommand{\acknowledgements}[1]{\gdef\theacknowledgements{#1}}

\newcommand{\dedication}[1]{\gdef\thededication{#1}}

% =================================================================

\newcommand{\wordcount}[2][]{
    \makeatletter
        \expandarg
        \StrCount{#2}{ }[\wc@spaces]
        \edef#1{\number\numexpr\wc@spaces+1\relax}
    \makeatother
}

\newcounter{numkeywordspt}
\newcounter{numkeywords}

\newtoggle{inResumo}\togglefalse{inResumo}
\newtoggle{inAbstract}\togglefalse{inAbstract}

\newcommand{\keyword}[1]{
\iftoggle{inResumo}{
    \noexpand\ifdef\noexpand\thekeywordspt
    {\noexpand\xdef\noexpand\thekeywordspt{\noexpand\thekeywordspt, #1}}
    {\noexpand\gdef\noexpand\thekeywordspt{#1}}
    \noexpand\stepcounter{numkeywordspt}
}{
    \iftoggle{inAbstract}{
        \noexpand\ifdef\noexpand\thekeywords
        {\noexpand\xdef\noexpand\thekeywords{\noexpand\thekeywords, #1}}
        {\noexpand\gdef\noexpand\thekeywords{#1}}
        \noexpand\stepcounter{numkeywords}
    }{
        \PackageError{Thesis}{The keyword command can only be used inside the Resumo and Abstract environments}{}
    }
}
}

\NewEnviron{resumo}{
    \iftoggle{inResumo}{
        \PackageError{Thesis}{You can't define Resumo within another Resumo}{}
    }{
        \iftoggle{inAbstract}{
            \PackageError{Thesis}{You can't define Resumo within the Abstract}{}
        }{
            \ifdef\abstractptdefined{
                \PackageError{Thesis}{The Resumo environment may only be used once}{}
            }{
                \toggletrue{inResumo}
                \xdef\theabstractpt{\BODY}

                \begingroup
                    \wordcount[\wcnt]{\BODY} 
                    \xdef\resumowordcount{\wcnt}
                \endgroup

                \gdef\abstractptdefined{}
            }
        }
    }
}[\togglefalse{inResumo}]
%
\RenewEnviron{abstract}{
    \iftoggle{inResumo}{
        \PackageError{Thesis}{You can't define the Abstract inside the Resumo}{}
    }{
        \iftoggle{inAbstract}{
            \PackageError{Thesis}{You can't define an Abstract within another Abstract}{}
        }{
            \ifdef\abstractdefined{
                \PackageError{Thesis}{The Abstract environment may only be used once}{}
            }{
                \toggletrue{inAbstract}
                \xdef\theabstract{\BODY}

                \begingroup
                    \wordcount[\wcnt]{\BODY} 
                    \xdef\abstractwordcount{\wcnt}
                \endgroup
                
                \gdef\abstractdefined{}
            }
        }
    }
}[\togglefalse{inAbstract}]

\newcommand{\waswere}[1]{
\ifnum\value{#1}>1
    were
\else
    \ifnum\value{#1}=0
        were
    \else
        was
    \fi
\fi
}

% =================================================================

\newcommand{\acronyms}[1]{\gdef\theacronyms{#1}}

% =================================================================

\definecolor{ISCTEDarkBlue}{rgb}{0,0.08,0.45}

\renewenvironment{document}{\olddocument

\sffamily
\frontFont
\begin{flushleft}
\includegraphics[width=6.03cm]{images/iscte.png}\\[3.3mm]

{\color{ISCTEDarkBlue}\hrulefill}
~\\
~\\
~\\
\ifdef\thetitle{
    \textbf{\thetitle}
}{
    \PackageError{Dissertation}{Your dissertation needs a title. Define one using the \texttt{title} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Title}}
}~\\
~\\
~\\
~\\
\ifdef\theauthor{
    \theauthor
}{
    \PackageError{Dissertation}{Your dissertation needs your name. Define one using the \texttt{author} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Author}}
}~\\
~\\
~\\
~\\
\ifdef\theprogram{
    \theprogram
}{
    \PackageError{Dissertation}{Your dissertation needs a Master's programme name. Define one using the \texttt{program} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Program}}
}~\\
~\\
~\\
~\\
\ifnum\value{numsupervisors}=1
    Supervisor:
    ~\\
    ~\\
    \thesupervisors
\else
    \ifnum\value{numsupervisors}<1
        \PackageError{Dissertation}{Your dissertation must have at least one supervisor, but you did not provide any}{}
        ~\\
        ~\\
        {\color{red}\textbf{\textsc{Error:} Dissertation needs at least 1 supervisor, but none were provided}}
    \else
        \ifnum\value{numsupervisors}>2
            ~\\
            ~\\
            {\color{red}\textbf{\textsc{Error:} Thesis can only have up to 2 supervisors (inclusive), but \arabic{numsupervisors} \waswere{numsupervisors} provided}}
        \else
            Supervisors:
            ~\\
            ~\\
            \thesupervisors
        \fi
    \fi
\fi
~\\
\vfill\ifdef\thedate{\dateorinvalid\themonth\theyear1}{
\PackageError{Dissertation}{Your dissertation needs a date. Define one using the \texttt{date} command}{}
{\color{red}\textbf{\textsc{Error:} Undefined Date}}
}
\end{flushleft}
\thispagestyle{empty}
\cleardoublepage
\begin{flushleft}
\begin{minipage}{\textwidth}
    \includegraphics[width=6.03cm]{images/ista.png}
    \ifdef\includeibslogo{
       \qquad\includegraphics[width=6.03cm]{images/ibs.png} 
    }{}
\end{minipage}\\[7mm]
{\color{ISCTEDarkBlue}\hrulefill}
~\\
~\\
~\\
\ifdef\thedepartment{
    \thedepartment
}{
    \PackageError{Dissertation}{Your dissertation needs a department name. Define one using the \texttt{department} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Department}}
}
~\\
~\\
~\\
~\\
\ifdef\thetitle{
    \textbf{\thetitle}
}{
    \PackageError{Dissertation}{Your dissertation needs a title. Define one using the \texttt{title} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Title}}
}~\\
~\\
~\\
~\\
\ifdef\theauthor{
    \theauthor
}{
    \PackageError{Dissertation}{Your dissertation needs your name. Define one using the \texttt{author} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Author}}
}~\\
~\\
~\\
~\\
\ifdef\theprogram{
    \theprogram
}{
    \PackageError{Dissertation}{Your dissertation needs a Master's programme name. Define one using the \texttt{program} command}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Program}}
}~\\
~\\
~\\
~\\
\ifnum\value{numsupervisors}=1
    Supervisor:
    ~\\
    ~\\
    \thesupervisors
\else
    \ifnum\value{numsupervisors}<1
        \PackageError{Dissertation}{Your dissertation must have at least one supervisor, but you did not provide any}{}
        ~\\
        ~\\
        {\color{red}\textbf{\textsc{Error:} Dissertation needs at least 1 supervisor, but none were provided}}
    \else
        \ifnum\value{numsupervisors}>2
            ~\\
            ~\\
            {\color{red}\textbf{\textsc{Error:} Thesis can only have up to 2 supervisors (inclusive), but \arabic{numsupervisors} \waswere{numsupervisors} provided}}
        \else
            Supervisors:
            ~\\
            ~\\
            \thesupervisors
        \fi
    \fi
\fi
~\\
\vfill\ifdef\thedate{\dateorinvalid\themonth\theyear0}{
\PackageError{Dissertation}{Your dissertation needs a date. Define one using the \texttt{date} command}{}
{\color{red}\textbf{\textsc{Error:} Undefined Date}}
}
\end{flushleft}
\thispagestyle{empty}
\rmfamily
\normalsize
\frontmatter
%\addtocontents{toc}{\setcounter{tocdepth}{2}}
\thispagestyle{empty}

\frontmatter
\addtocontents{toc}{\setcounter{tocdepth}{2}}
\thispagestyle{empty}

\ifdef\thededication
{
    \begin{dedicationenv}%
    \begin{flushright}
    \thededication
    \end{flushright}%
    \end{dedicationenv}
}

\setcounter{page}{1}
\pagenumbering{roman} %
\ifdef\theacknowledgements
{
    \chapter*{Acknowledgments}
    \theacknowledgements
}

\chapter*{Resumo}
\ifdef\theabstractpt{
\theabstractpt

\edef\cnt{\number\numexpr\resumowordcount-\value{numkeywordspt}\relax}
                    
\ifnum\cnt>250
    \PackageError{Thesis}{Your Resumo has too many words. The limit is 250, but you have written \cnt}{}
\else\fi

}{
    \PackageError{Thesis}{Your thesis must have an Abstract in Portuguese (Resumo)}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Abstract}}
}

\vspace{3ex}
\ifdef\thekeywordspt{
    \ifnum\value{numkeywordspt}<3
        \PackageError{Thesis}{Your thesis must have 3 to 6 keywords in Portuguese, but only \arabic{numkeywordspt} \waswere{numkeywordspt} provided}{}
    \else
        \ifnum\value{numkeywordspt}>6
            \PackageError{Thesis}{Your thesis must have 3 to 6 keywords in Portuguese, but \arabic{numkeywordspt} \waswere{numkeywordspt} provided.}{}
        \else\fi
    \fi
    \noindent\textbf{Palavras-Chave:} \textit{\thekeywordspt}
}{
\PackageError{Thesis}{Your thesis must have 3 to 6 keywords in Portuguese, but \arabic{numkeywordspt} \waswere{numkeywordspt} provided}{}
\noindent\textbf{Palavras-Chave:} {\color{red}\textbf{\textsc{Error:} Undefined Keywords}}
}

\chapter*{Abstract}
\ifdef\theabstract{
\theabstract

\edef\cnt{\number\numexpr\abstractwordcount-\value{numkeywordspt}\relax}
                    
\ifnum\cnt>250
    \PackageError{Thesis}{Your Abstract has too many words. The limit is 250, but you have written \cnt}{}
\else\fi

}{
    \PackageError{Thesis}{Your thesis must have an Abstract in English}{}
    {\color{red}\textbf{\textsc{Error:} Undefined Abstract}}
}

\vspace{3ex}
\ifdef\thekeywords{
    \ifnum\value{numkeywords}<3
        \PackageError{Thesis}{Your thesis must have 3 to 6 keywords in English, but only \arabic{numkeywords} \waswere{numkeywords} provided}{}
    \else
        \ifnum\value{numkeywords}>6
            \PackageError{Thesis}{Your thesis must have 3 to 6 keywords in English, but \arabic{numkeywords} \waswere{numkeywords} provided}{}
        \else\fi
    \fi
    \noindent\textbf{Keywords:} \textit{\thekeywords}
}{
\noindent\textbf{Keywords:} {\color{red}\textbf{\textsc{Error:} Undefined Keywords}}
}

\ifnum\value{numkeywordspt}=\value{numkeywords}\else
    \PackageError{Thesis}{Portuguese and English keywords don't match. There are \arabic{numkeywordspt} Portuguese keywords and \arabic{numkeywords} English keywords}{}
\fi

\tableofcontents
\listoffigures
\listoftables
\cleardoublepage
%\printglossary[type=\acronymtype, nonumberlist, nogroupskip]
\ifdef\theacronyms
{
    \chapter*{List of Acronyms}
    \begin{acronym}
    \theacronyms
    \end{acronym}
}

\mainmatter

\hyphenation{wri-te he-re pro-per hy-phe-ni-za-tion
}%

\setcounter{page}{1}
\pagenumbering{arabic}
}{
\printbibliography[title={References}]
\oldenddocument
}